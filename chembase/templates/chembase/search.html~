{% extends "chembase/base.html" %}

{% block content %}
{% load static %}
{% load chembase_tags %}
<link rel='stylesheet' type="text/css" href="{% static 'chembase/style_search.css' %}">
<script src="{% static 'chembase/script_search.js' %}"></script>


<div class='main'>

<div class='search_options'>
<h2>Search compounds:</h2>
<form action="{% url 'chembase:search' %}" method="get">
   {{form.non_field_errors}}
	<div class='field'>
	{{form.text.errors}}
	<label for="{{form.text.id_for_label}}">Search text:</label>
	{{form.text}}
	</div> 
	<h3 class='control'>Options</h3>
	<div class='options'>
	<div class='field_check'>
	{{form.deleted.errors}}
	<label for="{{form.deleted.id_for_label}}">Include deleted items:</label>
	{{form.deleted}}
	</div>
	<div class='field'>
	{{form.stype.errors}}
	<label for="{{form.stype.id_for_label}}">Find:</label>
	{{form.stype}}
	</div> 

	<div class='field'>
	{{form.cutoff.errors}}
	<label for="{{form.cutoff.id_for_label}}">Similarity cutoff:</label>
	{{form.cutoff}}
	</div> 

	</div>
	<h3 class='control' id='str_open'>Structure edit</h3>
	{% if str %}
	<div id='ketcher_div'>
	{% else %}
	<div style='display:none' id='ketcher_div'>
	{% endif %}
	<iframe id='ketcher-frame' src="{% static 'chembase/ketcher/ketcher.html' %}" scrolling='no'></iframe>
	</div>
	{% if str %}
	<script type="text/javascript" >
	$('#ketcher-frame').on('load', function () {
          var ketcher = this.contentWindow.ketcher,
              source = $('#id_smiles'),
              molecule=localStorage.getItem('molecule');
              
			 console.log(molecule);
			 ketcher.setMolecule(molecule);
			 source.val(ketcher.getSmiles());
			 
			 });
	</script>
	{% endif %}
	<input type='hidden' name='smiles' id='id_smiles' />
	<input type="submit" value="Search" id='form_input' />
</form>


</div>
{% if results %}
<h2>Search results:</h2>
<hr class='sep'>
{% for compound in results %}
	{% if compound.how_many_items %}
	<div class='hit'>
	{% else %}
	<div class='empty_hit'>
	{% endif %}
	<div class='top'>
	<div class='image'>
	<img class='structure' src='{% static "/chembase/" %}{{compound.image }}' alt='structure'/>	
	</div>
<!--	<div class='name_top'> -->
	<div class='res_field'>	
		<a target='_blank' href="{% url 'chembase:detail' compound.id %}" class='name'>{{compound.name}}</a>
		{% if compound.subtitle %}
		<p class='subtitle'>{{compound.subtitle}}</p>
		{% endif %}
	</div>
<!--	</div>  -->
	<div class='res_field' id='cas'>
	<p class="value">
	CAS: {{compound.cas}}
	</p>	
	</div>
	
	<div class='res_field' id='formula'>
	<p class="value">
	{{compound.formulaHTML|safe}}	
	</p>
	</div>

	<div class='res_field'>
	<p class="res_field">
	{{compound.how_many_items}} item(s) available
	</p>	
	</div>
	</div>
	<div class='bottom' style='display:none' >
	<div class='other_names'>
	<p class="subtitle">
	Other names: <br>
	{{compound.all_names}} <br>
	PL: {{compound.pl_name}}, {{compound.pl_subtitle}}
	</p>
	</div>
	<div class='items'>
	<p class="subtitle">
	Items:
	{% for item in compound.item_set.all %}
		{% if not item.is_deleted %}
			{{item.localize}}
			{% if item.annotation_set.all %}
				{% for ann in item.annotation_set.all %}
					({{ann.annotation}})
				{% endfor %}
			{% endif %}
			,
		{% endif %} 
	{% endfor %}
	</p>
	</div>
	<div class='picts'>
	{% for pict in compound.pictograms.all %}
	<img class='pictogram' src='{% static "/chembase/" %}{{pict.path}}' alt='pictograms'/>
	{% endfor %}
	</div>
	</div>
	</div>
	<hr class='sep'>
	
{% endfor %}

<div class="pagination">
    <div class="step-links">
        {% if results.has_previous %}
            <a href="?{% url_replace page=results.previous_page_number %}">Previous</a>
        {% endif %}

        <span class="current">
            Page {{ results.number }} of {{ results.paginator.num_pages }}
        </span>

        {% if results.has_next %}
            <a href="?{% url_replace page=results.next_page_number %}">Next</a>
        {% endif %}
    </div>
</div>


{% endif %}
</div>
{% endblock %}